"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var log_factory_1 = require("../logs/log.factory");
var http_interface_1 = require("./http.interface");
var cfg_config_1 = require("../config/cfg.config");
var util_1 = require("../utils/util");
var HttpProxy = (function () {
    function HttpProxy() {
    }
    HttpProxy.request = function (api, params) {
        var _this = this;
        return new Promise(function (resolve, reject) {
            if (_this.guard(api)) {
                var token = wx.getStorageSync('token');
                var dtNow = new Date().valueOf();
                if (!!token && token.expired < dtNow) {
                    if (!_this.freshStatus) {
                        _this.freshStatus = true;
                        _this.doRequest(cfg_config_1.Auth.refreshTokenUrl, false, { data: { refreshToken: token.refresh_token } }).then(function (res) {
                            var response_res = res.result;
                            if (response_res.token) {
                                response_res.token.expired = util_1.transExpiresDt(response_res.token.expires_in);
                                wx.setStorageSync('token', response_res.token);
                                _this.freshStatus = false;
                                _this.doRequest(api, true, params).then(function (res) {
                                    resolve(res);
                                }).catch(function (err) {
                                    reject(err);
                                });
                            }
                        }).catch(function (err) {
                            if (err.code === 210 || err.code === 220) {
                            }
                        });
                    }
                    else {
                        var result = _this.recurRequest(api, params);
                        resolve(result);
                    }
                }
                else {
                    _this.doRequest(api, true, params).then(function (res) { return resolve(res); }).catch(function (err) { return reject(err); });
                }
            }
            else {
                _this.doRequest(api, false, params).then(function (res) { return resolve(res); }).catch(function (err) { return reject(err); });
            }
        });
    };
    HttpProxy.doRequest = function (api, tokenCheck, params) {
        var _this = this;
        var result;
        if (tokenCheck) {
            var token = wx.getStorageSync('token');
            if (!!token) {
                params = params || {};
                params.data = params.data || {};
                Object.assign(params.data, { access_token: token.access_token });
            }
        }
        api = this.urlPrefix(api, cfg_config_1.apiPrefix);
        if (this.isDebug) {
            this.log.log('mock request: ' + api, params);
        }
        else {
            var httpApi_1 = this.analyzeApi(api);
            if (!!params && !!params.path) {
                httpApi_1.url = this.urlFormat(httpApi_1.url, params.path);
            }
            this.log.log('requset: ' + http_interface_1.HttpMethod[httpApi_1.method] + ' ' + httpApi_1.url, params.data);
            var method_1 = http_interface_1.HttpMethod[httpApi_1.method];
            result = new Promise(function (resolve, reject) {
                wx.request({
                    url: httpApi_1.url,
                    data: params.data,
                    method: method_1,
                    header: {
                        'Content-Type': 'application/json'
                    },
                    success: function (res) {
                        _this.log.log('response: ' + http_interface_1.HttpMethod[httpApi_1.method] + ' ' + httpApi_1.url, res.data);
                        _this.dealWithCode({ response: res, resolve: resolve, reject: reject });
                    },
                    fail: function (res) {
                        reject(res);
                    }
                });
            });
        }
        return result;
    };
    HttpProxy.dealWithCode = function (_a) {
        var response = _a.response, resolve = _a.resolve, reject = _a.reject;
        var dataResponse = response.data;
        if (!!dataResponse && dataResponse.code === 100) {
            resolve(dataResponse);
        }
        else if (dataResponse.code === 210 || dataResponse.code === 220) {
            reject(dataResponse);
        }
        else {
            wx.showModal({
                title: "接口请求出错",
                showCancel: false,
                content: dataResponse.result + ("(" + dataResponse.code + ")")
            });
            reject(dataResponse);
        }
    };
    HttpProxy.recurRequest = function (api, params) {
        var _this = this;
        var result;
        if (this.freshStatus) {
            setTimeout(function () {
                _this.recurRequest(api, params);
            }, 1000);
        }
        else {
            result = this.doRequest(api, true, params);
        }
        return result;
    };
    HttpProxy.urlFormat = function (url, pathParam) {
        var result = url;
        if (!!pathParam) {
            for (var key in pathParam) {
                if (pathParam.hasOwnProperty(key)) {
                    result = result.replace('{' + key + '}', pathParam[key]);
                }
            }
        }
        return result;
    };
    HttpProxy.analyzeApi = function (api) {
        var result;
        if (typeof api === 'string') {
            var splits = api.split(' ');
            var method = http_interface_1.HttpMethod.GET;
            var url = void 0;
            if (splits.length === 1) {
                url = splits[0];
            }
            else {
                url = splits[1];
                switch (splits[0].toLowerCase()) {
                    case 'post':
                        method = http_interface_1.HttpMethod.POST;
                        break;
                    case 'put':
                        method = http_interface_1.HttpMethod.PUT;
                        break;
                    case 'delete':
                        method = http_interface_1.HttpMethod.DELETE;
                        break;
                    default:
                        method = http_interface_1.HttpMethod.GET;
                        break;
                }
            }
            result = {
                method: method,
                url: url
            };
        }
        else {
            result = api;
        }
        return result;
    };
    HttpProxy.urlPrefix = function (url, prefix) {
        var result = url;
        if (!!prefix) {
            if (url.indexOf(' ') > 0) {
                var splits = url.split(' ');
                result = splits[0] + ' ' + prefix + '/' + splits[1];
            }
            else {
                result = prefix + '/' + result;
            }
        }
        return result;
    };
    HttpProxy.guard = function (api) {
        var result = false;
        if (cfg_config_1.Auth.enable) {
            result = true;
            if (api.indexOf(cfg_config_1.Auth.refreshTokenUrl) > 0) {
                result = false;
            }
            else if (api.indexOf(cfg_config_1.Auth.login) > 0) {
                result = false;
            }
        }
        return result;
    };
    HttpProxy.log = log_factory_1.LogFactory.get(HttpProxy);
    HttpProxy.freshStatus = false;
    HttpProxy.isDebug = false;
    return HttpProxy;
}());
exports.HttpProxy = HttpProxy;

//# sourceMappingURL=data:application/json;charset=utf8;base64,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a01DLElBQUE7QUFsTVksOEJBQVMiLCJmaWxlIjoiaHR0cHMvaHR0cC5wcm94eS5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7SUxvZ30gZnJvbSAnLi4vbG9ncy9sb2cuaW50ZXJmYWNlJ1xyXG5pbXBvcnQge0xvZ0ZhY3Rvcnl9IGZyb20gJy4uL2xvZ3MvbG9nLmZhY3RvcnknXHJcbmltcG9ydCB7UGFyYW1zLElUb2tlbiwgQXBpLCBIdHRwTWV0aG9kLElEZWFsV2l0aENvZGVPcHRpb24sSUNvbW1vblJlc3BvbnNlLElSZXNwb25zZVJlc3VsdH0gZnJvbSAnLi9odHRwLmludGVyZmFjZSdcclxuaW1wb3J0IHtBdXRoLGFwaVByZWZpeH0gZnJvbSAnLi4vY29uZmlnL2NmZy5jb25maWcnXHJcbmltcG9ydCB7dHJhbnNFeHBpcmVzRHR9IGZyb20gJy4uL3V0aWxzL3V0aWwnXHJcbmV4cG9ydCBjbGFzcyBIdHRwUHJveHkge1xyXG4gICAgcHJpdmF0ZSBzdGF0aWMgbG9nOiBJTG9nID0gTG9nRmFjdG9yeS5nZXQoSHR0cFByb3h5KVxyXG4gICAgcHJpdmF0ZSBzdGF0aWMgZnJlc2hTdGF0dXM6IGJvb2xlYW4gPSBmYWxzZVxyXG4gICAgcHJpdmF0ZSBzdGF0aWMgaXNEZWJ1ZzogYm9vbGVhbiA9IGZhbHNlXHJcbiAgICBjb25zdHJ1Y3Rvcigpe31cclxuICAgIHB1YmxpYyBzdGF0aWMgcmVxdWVzdChhcGk6IHN0cmluZywgcGFyYW1zOiBQYXJhbXMpOiBQcm9taXNlPG9iamVjdD4ge1xyXG4gICAgICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XHJcbiAgICAgICAgICAgIGlmKHRoaXMuZ3VhcmQoYXBpKSkge1xyXG4gICAgICAgICAgICAgICBjb25zdCB0b2tlbjogSVRva2VuID0gd3guZ2V0U3RvcmFnZVN5bmMoJ3Rva2VuJylcclxuICAgICAgICAgICAgICAgY29uc3QgZHROb3c6IG51bWJlciA9IG5ldyBEYXRlKCkudmFsdWVPZigpXHJcbiAgICAgICAgICAgICAgIGlmKCEhdG9rZW4gJiYgdG9rZW4uZXhwaXJlZCA8IGR0Tm93KSB7XHJcbiAgICAgICAgICAgICAgICAgICBpZighdGhpcy5mcmVzaFN0YXR1cykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZnJlc2hTdGF0dXMgPSB0cnVlXHJcbiAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5kb1JlcXVlc3QoQXV0aC5yZWZyZXNoVG9rZW5VcmwsIGZhbHNlLCB7ZGF0YToge3JlZnJlc2hUb2tlbjogdG9rZW4ucmVmcmVzaF90b2tlbn19KS50aGVuKChyZXM6IElDb21tb25SZXNwb25zZSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgcmVzcG9uc2VfcmVzOiBJUmVzcG9uc2VSZXN1bHQgPSByZXMucmVzdWx0IFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYocmVzcG9uc2VfcmVzLnRva2VuKXtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXNwb25zZV9yZXMudG9rZW4uZXhwaXJlZCA9IHRyYW5zRXhwaXJlc0R0KHJlc3BvbnNlX3Jlcy50b2tlbi5leHBpcmVzX2luKVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHd4LnNldFN0b3JhZ2VTeW5jKCd0b2tlbicsIHJlc3BvbnNlX3Jlcy50b2tlbilcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmZyZXNoU3RhdHVzID0gZmFsc2VcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5kb1JlcXVlc3QoYXBpLCB0cnVlLCBwYXJhbXMpLnRoZW4oKHJlczogSUNvbW1vblJlc3BvbnNlKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc29sdmUocmVzKVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pLmNhdGNoKGVyciA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlamVjdChlcnIpXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gXHJcbiAgICAgICAgICAgICAgICAgICAgICAgfSkuY2F0Y2goZXJyID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoZXJyLmNvZGUgPT09IDIxMCB8fCBlcnIuY29kZSA9PT0gMjIwKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gd3gucmVtb3ZlU3RvcmFnZVN5bmMoJ3VzZXJJbmZvJylcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyB3eC5yZW1vdmVTdG9yYWdlU3luYygndG9rZW4nKVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHd4LnJlbW92ZVN0b3JhZ2VTeW5jKCd3eCcpXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gY29uc3QgdXJsID0gZ2V0UGFnZVVybCgpXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gd3gucmVkaXJlY3RUbyh7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gICAgIHVybDogJy9wYWdlcy9hdXRob3JpemUvaW5kZXg/dXJsPS8nICsgdXJsLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIH0pXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gY29uc29sZS5sb2codXJsKVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgLy90b2tlbuWIt+aWsOS4rVxyXG4gICAgICAgICAgICAgICAgICAgICAgIGxldCByZXN1bHQgPSB0aGlzLnJlY3VyUmVxdWVzdChhcGksIHBhcmFtcylcclxuICAgICAgICAgICAgICAgICAgICAgICByZXNvbHZlKHJlc3VsdClcclxuICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgIHRoaXMuZG9SZXF1ZXN0KGFwaSwgdHJ1ZSwgcGFyYW1zKS50aGVuKHJlcyA9PiByZXNvbHZlKHJlcykpLmNhdGNoKGVyciA9PiByZWplY3QoZXJyKSlcclxuICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5kb1JlcXVlc3QoYXBpLCBmYWxzZSwgcGFyYW1zKS50aGVuKHJlcyA9PiByZXNvbHZlKHJlcykpLmNhdGNoKGVyciA9PiByZWplY3QoZXJyKSlcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pXHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBzdGF0aWMgZG9SZXF1ZXN0KGFwaTogc3RyaW5nLCB0b2tlbkNoZWNrOiBib29sZWFuLCBwYXJhbXM6IFBhcmFtcykge1xyXG4gICAgICAgIGxldCByZXN1bHQ6IFByb21pc2U8b2JqZWN0PlxyXG4gICAgICAgIGlmKHRva2VuQ2hlY2spIHtcclxuICAgICAgICAgICAgY29uc3QgdG9rZW46IElUb2tlbiA9IHd4LmdldFN0b3JhZ2VTeW5jKCd0b2tlbicpXHJcbiAgICAgICAgICAgIGlmKCEhdG9rZW4pIHtcclxuICAgICAgICAgICAgICAgIHBhcmFtcyA9IHBhcmFtcyB8fCB7fTtcclxuICAgICAgICAgICAgICAgIHBhcmFtcy5kYXRhID0gcGFyYW1zLmRhdGEgfHwge307XHJcbiAgICAgICAgICAgICAgICBPYmplY3QuYXNzaWduKHBhcmFtcy5kYXRhLCB7IGFjY2Vzc190b2tlbjogdG9rZW4uYWNjZXNzX3Rva2VufSlcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICBhcGkgPSB0aGlzLnVybFByZWZpeChhcGksIGFwaVByZWZpeCk7XHJcbiAgICAgICAgaWYodGhpcy5pc0RlYnVnKSB7XHJcbiAgICAgICAgICAgIHRoaXMubG9nLmxvZygnbW9jayByZXF1ZXN0OiAnICsgYXBpLCBwYXJhbXMpXHJcbiAgICAgICAgfSBlbHNlIHsgICAgICAgICAgIFxyXG4gICAgICAgICAgICBjb25zdCBodHRwQXBpID0gdGhpcy5hbmFseXplQXBpKGFwaSlcclxuICAgICAgICAgICAgaWYoISFwYXJhbXMgJiYgISFwYXJhbXMucGF0aCkge1xyXG4gICAgICAgICAgICAgICAgaHR0cEFwaS51cmwgPSB0aGlzLnVybEZvcm1hdChodHRwQXBpLnVybCwgcGFyYW1zLnBhdGgpXHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgdGhpcy5sb2cubG9nKCdyZXF1c2V0OiAnICsgSHR0cE1ldGhvZFtodHRwQXBpLm1ldGhvZF0gKycgJyArIGh0dHBBcGkudXJsLCBwYXJhbXMuZGF0YSlcclxuICAgICAgICAgICAgY29uc3QgbWV0aG9kOiBhbnkgPSBIdHRwTWV0aG9kW2h0dHBBcGkubWV0aG9kXVxyXG4gICAgICAgICAgICByZXN1bHQgPSBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XHJcbiAgICAgICAgICAgICAgICB3eC5yZXF1ZXN0KHtcclxuICAgICAgICAgICAgICAgICAgICB1cmw6IGh0dHBBcGkudXJsLFxyXG4gICAgICAgICAgICAgICAgICAgIGRhdGE6IHBhcmFtcy5kYXRhLFxyXG4gICAgICAgICAgICAgICAgICAgIG1ldGhvZDogbWV0aG9kLFxyXG4gICAgICAgICAgICAgICAgICAgIGhlYWRlcjoge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAnQ29udGVudC1UeXBlJzogJ2FwcGxpY2F0aW9uL2pzb24nXHJcbiAgICAgICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAgICAgICBzdWNjZXNzOiAocmVzOiBhbnkpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5sb2cubG9nKCdyZXNwb25zZTogJyArIEh0dHBNZXRob2RbaHR0cEFwaS5tZXRob2RdICsnICcgKyBodHRwQXBpLnVybCwgcmVzLmRhdGEpXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZGVhbFdpdGhDb2RlKHtyZXNwb25zZTogcmVzLCByZXNvbHZlLCByZWplY3R9KVxyXG4gICAgICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICAgICAgZmFpbDogKHJlczogYW55KSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlamVjdChyZXMpXHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgfSlcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIHJlc3VsdFxyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgc3RhdGljIGRlYWxXaXRoQ29kZSh7cmVzcG9uc2UsIHJlc29sdmUsIHJlamVjdH06IElEZWFsV2l0aENvZGVPcHRpb24pIHtcclxuICAgICAgICBjb25zdCBkYXRhUmVzcG9uc2U6IElDb21tb25SZXNwb25zZSA9IHJlc3BvbnNlLmRhdGFcclxuICAgICAgICBpZighIWRhdGFSZXNwb25zZSAmJiBkYXRhUmVzcG9uc2UuY29kZSA9PT0gMTAwKXtcclxuICAgICAgICAgICAgcmVzb2x2ZShkYXRhUmVzcG9uc2UpXHJcbiAgICAgICAgfWVsc2UgaWYoZGF0YVJlc3BvbnNlLmNvZGUgPT09IDIxMCB8fCBkYXRhUmVzcG9uc2UuY29kZSA9PT0gMjIwKXtcclxuICAgICAgICAgICAgcmVqZWN0KGRhdGFSZXNwb25zZSlcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICB3eC5zaG93TW9kYWwoe1xyXG4gICAgICAgICAgICAgICAgdGl0bGU6IFwi5o6l5Y+j6K+35rGC5Ye66ZSZXCIsXHJcbiAgICAgICAgICAgICAgICBzaG93Q2FuY2VsOiBmYWxzZSxcclxuICAgICAgICAgICAgICAgIGNvbnRlbnQ6IGRhdGFSZXNwb25zZS5yZXN1bHQgKyBgKCR7ZGF0YVJlc3BvbnNlLmNvZGV9KWBcclxuICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICByZWplY3QoZGF0YVJlc3BvbnNlKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBzdGF0aWMgcmVjdXJSZXF1ZXN0KGFwaTogc3RyaW5nLCBwYXJhbXM6IFBhcmFtcykge1xyXG4gICAgICAgIGxldCByZXN1bHQ7XHJcbiAgICAgICAgaWYodGhpcy5mcmVzaFN0YXR1cykge1xyXG4gICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHtcclxuICAgICAgICAgICAgICAgIHRoaXMucmVjdXJSZXF1ZXN0KGFwaSwgcGFyYW1zKVxyXG4gICAgICAgICAgICB9LCAxMDAwKVxyXG4gICAgICAgIH1lbHNlIHtcclxuICAgICAgICAgICAgcmVzdWx0ID0gdGhpcy5kb1JlcXVlc3QoYXBpLCB0cnVlLCBwYXJhbXMpXHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiByZXN1bHRcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIHN0YXRpYyB1cmxGb3JtYXQgKHVybDogc3RyaW5nLCBwYXRoUGFyYW0/OiBhbnkpOiBzdHJpbmcge1xyXG4gICAgICAgIGxldCByZXN1bHQgPSB1cmw7XHJcbiAgICAgICAgaWYoISFwYXRoUGFyYW0pIHtcclxuICAgICAgICAgICAgZm9yKGNvbnN0IGtleSBpbiBwYXRoUGFyYW0pIHtcclxuICAgICAgICAgICAgICAgIGlmKHBhdGhQYXJhbS5oYXNPd25Qcm9wZXJ0eShrZXkpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmVzdWx0ID0gcmVzdWx0LnJlcGxhY2UoJ3snICsga2V5ICsgJ30nLCBwYXRoUGFyYW1ba2V5XSlcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gcmVzdWx0O1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgc3RhdGljIGFuYWx5emVBcGkgKGFwaTogc3RyaW5nIHwgQXBpKTogQXBpIHtcclxuICAgICAgICBsZXQgcmVzdWx0OiBBcGk7XHJcbiAgICAgICAgaWYodHlwZW9mIGFwaSA9PT0gJ3N0cmluZycpIHtcclxuICAgICAgICAgICAgY29uc3Qgc3BsaXRzID0gYXBpLnNwbGl0KCcgJyk7XHJcbiAgICAgICAgICAgIGxldCBtZXRob2Q6IEh0dHBNZXRob2QgPSBIdHRwTWV0aG9kLkdFVDtcclxuICAgICAgICAgICAgbGV0IHVybDogc3RyaW5nO1xyXG4gICAgICAgICAgICBpZihzcGxpdHMubGVuZ3RoID09PSAxKSB7XHJcbiAgICAgICAgICAgICAgICB1cmwgPSBzcGxpdHNbMF07XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICB1cmwgPSBzcGxpdHNbMV07XHJcbiAgICAgICAgICAgICAgICBzd2l0Y2goc3BsaXRzWzBdLnRvTG93ZXJDYXNlKCkpIHtcclxuICAgICAgICAgICAgICAgICAgICBjYXNlICdwb3N0JzpcclxuICAgICAgICAgICAgICAgICAgICAgICAgbWV0aG9kID0gSHR0cE1ldGhvZC5QT1NUO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgICAgICBjYXNlICdwdXQnOlxyXG4gICAgICAgICAgICAgICAgICAgICAgICBtZXRob2QgPSBIdHRwTWV0aG9kLlBVVDtcclxuICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgICAgICAgICAgY2FzZSAnZGVsZXRlJzpcclxuICAgICAgICAgICAgICAgICAgICAgICAgbWV0aG9kID0gSHR0cE1ldGhvZC5ERUxFVEU7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgICAgIGRlZmF1bHQ6XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIG1ldGhvZCA9IEh0dHBNZXRob2QuR0VUXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHJlc3VsdCA9IHtcclxuICAgICAgICAgICAgICAgIG1ldGhvZDogbWV0aG9kLFxyXG4gICAgICAgICAgICAgICAgdXJsOiB1cmxcclxuICAgICAgICAgICAgfVxyXG4gICAgfSBlbHNlIHtcclxuICAgICAgICByZXN1bHQgPSBhcGk7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gcmVzdWx0O1xyXG4gICAgICAgIFxyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgc3RhdGljIHVybFByZWZpeCh1cmw6IHN0cmluZywgcHJlZml4OiBzdHJpbmcpIDogc3RyaW5ne1xyXG4gICAgICAgIGxldCByZXN1bHQ6IHN0cmluZyA9IHVybDtcclxuICAgICAgICBpZighIXByZWZpeCkge1xyXG4gICAgICAgICAgICBpZih1cmwuaW5kZXhPZignICcpID4gMCkge1xyXG4gICAgICAgICAgICAgICAgY29uc3Qgc3BsaXRzID0gdXJsLnNwbGl0KCcgJylcclxuICAgICAgICAgICAgICAgIHJlc3VsdCA9IHNwbGl0c1swXSArICcgJyArIHByZWZpeCArICcvJyArIHNwbGl0c1sxXTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHJlc3VsdCA9IHByZWZpeCArICcvJyArIHJlc3VsdFxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiByZXN1bHQ7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBzdGF0aWMgZ3VhcmQoYXBpOiBzdHJpbmcpOmJvb2xlYW4ge1xyXG4gICAgICAgIGxldCByZXN1bHQ6IGJvb2xlYW4gPSBmYWxzZTtcclxuICAgICAgICBpZihBdXRoLmVuYWJsZSkge1xyXG4gICAgICAgICAgICByZXN1bHQgPSB0cnVlXHJcbiAgICAgICAgICAgIGlmKGFwaS5pbmRleE9mKEF1dGgucmVmcmVzaFRva2VuVXJsKSA+IDApIHtcclxuICAgICAgICAgICAgICAgIHJlc3VsdCA9IGZhbHNlXHJcbiAgICAgICAgICAgIH0gZWxzZSBpZihhcGkuaW5kZXhPZihBdXRoLmxvZ2luKSA+IDApe1xyXG4gICAgICAgICAgICAgICAgcmVzdWx0ID0gZmFsc2VcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gcmVzdWx0XHJcbiAgICB9XHJcbn0iXX0=
