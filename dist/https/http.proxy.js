"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var log_factory_1 = require("../logs/log.factory");
var http_interface_1 = require("./http.interface");
var cfg_config_1 = require("../config/cfg.config");
var _mock_1 = require("../api/__mock__/_mock");
var HttpProxy = (function () {
    function HttpProxy() {
    }
    HttpProxy.doRequest = function (api, tokenCheck, params) {
        var _this = this;
        var result;
        if (tokenCheck) {
            var token = wx.getStorageSync('token');
            if (!!token) {
                params = params || {};
                params.data = params.data || {};
                Object.assign(params.data, { access_token: token.access_token });
            }
        }
        if (cfg_config_1.cfgMock.enable) {
            this.log.log('mock request: ' + api, params);
            result = new Promise(function (resolve, reject) {
                _mock_1.getMock({ url: api, body: params }).then(function (res) {
                    _this.log.log('mock response: ' + api, res);
                    resolve(res);
                });
            });
        }
        else {
            api = this.urlPrefix(api, cfg_config_1.apiPrefix);
            var httpApi_1 = this.analyzeApi(api);
            if (!!params && !!params.path) {
                httpApi_1.url = this.urlFormat(httpApi_1.url, params.path);
            }
            this.log.log('requset: ' + http_interface_1.HttpMethod[httpApi_1.method] + ' ' + httpApi_1.url, params.data);
            var method_1 = http_interface_1.HttpMethod[httpApi_1.method];
            result = new Promise(function (resolve, reject) {
                wx.request({
                    url: httpApi_1.url,
                    data: params.data,
                    method: method_1,
                    header: {
                        'Content-Type': 'application/json'
                    },
                    success: function (res) {
                        _this.log.log('response: ' + http_interface_1.HttpMethod[httpApi_1.method] + ' ' + httpApi_1.url, res.data);
                        _this.dealWithCode({ response: res, resolve: resolve, reject: reject });
                    },
                    fail: function (res) {
                        reject(res);
                    }
                });
            });
        }
        return result;
    };
    HttpProxy.dealWithCode = function (_a) {
        var response = _a.response, resolve = _a.resolve, reject = _a.reject;
        var dataResponse = response.data;
        if (!!dataResponse && dataResponse.code === 100) {
            resolve(dataResponse);
        }
        else if (dataResponse.code === 210 || dataResponse.code === 220) {
            reject(dataResponse);
        }
        else {
            wx.showModal({
                title: "接口请求出错",
                showCancel: false,
                content: dataResponse.result + ("(" + dataResponse.code + ")")
            });
            reject(dataResponse);
        }
    };
    HttpProxy.urlFormat = function (url, pathParam) {
        var result = url;
        if (!!pathParam) {
            for (var key in pathParam) {
                if (pathParam.hasOwnProperty(key)) {
                    result = result.replace('{' + key + '}', pathParam[key]);
                }
            }
        }
        return result;
    };
    HttpProxy.analyzeApi = function (api) {
        var result;
        if (typeof api === 'string') {
            var splits = api.split(' ');
            var method = http_interface_1.HttpMethod.GET;
            var url = void 0;
            if (splits.length === 1) {
                url = splits[0];
            }
            else {
                url = splits[1];
                switch (splits[0].toLowerCase()) {
                    case 'post':
                        method = http_interface_1.HttpMethod.POST;
                        break;
                    case 'put':
                        method = http_interface_1.HttpMethod.PUT;
                        break;
                    case 'delete':
                        method = http_interface_1.HttpMethod.DELETE;
                        break;
                    default:
                        method = http_interface_1.HttpMethod.GET;
                        break;
                }
            }
            result = {
                method: method,
                url: url
            };
        }
        else {
            result = api;
        }
        return result;
    };
    HttpProxy.urlPrefix = function (url, prefix) {
        var result = url;
        if (!!prefix) {
            if (url.indexOf(' ') > 0) {
                var splits = url.split(' ');
                result = splits[0] + ' ' + prefix + '/' + splits[1];
            }
            else {
                result = prefix + '/' + result;
            }
        }
        return result;
    };
    HttpProxy.log = log_factory_1.LogFactory.get(HttpProxy);
    return HttpProxy;
}());
exports.HttpProxy = HttpProxy;

//# sourceMappingURL=data:application/json;charset=utf8;base64,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WUFDSCxNQUFNLEdBQUcsR0FBRyxDQUFDO1NBQ2hCO1FBQ0QsT0FBTyxNQUFNLENBQUM7SUFFZCxDQUFDO0lBRWMsbUJBQVMsR0FBeEIsVUFBeUIsR0FBVyxFQUFFLE1BQWM7UUFDaEQsSUFBSSxNQUFNLEdBQVcsR0FBRyxDQUFDO1FBQ3pCLElBQUcsQ0FBQyxDQUFDLE1BQU0sRUFBRTtZQUNULElBQUcsR0FBRyxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLEVBQUU7Z0JBQ3JCLElBQU0sTUFBTSxHQUFHLEdBQUcsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUE7Z0JBQzdCLE1BQU0sR0FBRyxNQUFNLENBQUMsQ0FBQyxDQUFDLEdBQUcsR0FBRyxHQUFHLE1BQU0sR0FBRyxHQUFHLEdBQUcsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDO2FBQ3ZEO2lCQUFNO2dCQUNILE1BQU0sR0FBRyxNQUFNLEdBQUcsR0FBRyxHQUFHLE1BQU0sQ0FBQTthQUNqQztTQUNKO1FBQ0QsT0FBTyxNQUFNLENBQUM7SUFDbEIsQ0FBQztJQTdIYyxhQUFHLEdBQVMsd0JBQVUsQ0FBQyxHQUFHLENBQUMsU0FBUyxDQUFDLENBQUE7SUE4SHhELGdCQUFDO0NBL0hELEFBK0hDLElBQUE7QUEvSFksOEJBQVMiLCJmaWxlIjoiaHR0cHMvaHR0cC5wcm94eS5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7SUxvZ30gZnJvbSAnLi4vbG9ncy9sb2cuaW50ZXJmYWNlJ1xyXG5pbXBvcnQge0xvZ0ZhY3Rvcnl9IGZyb20gJy4uL2xvZ3MvbG9nLmZhY3RvcnknXHJcbmltcG9ydCB7UGFyYW1zLElUb2tlbiwgQXBpLCBIdHRwTWV0aG9kLElEZWFsV2l0aENvZGVPcHRpb24sSUNvbW1vblJlc3BvbnNlfSBmcm9tICcuL2h0dHAuaW50ZXJmYWNlJ1xyXG5pbXBvcnQge2FwaVByZWZpeCwgY2ZnTW9ja30gZnJvbSAnLi4vY29uZmlnL2NmZy5jb25maWcnXHJcbmltcG9ydCB7Z2V0TW9ja30gZnJvbSAnLi4vYXBpL19fbW9ja19fL19tb2NrJ1xyXG5leHBvcnQgY2xhc3MgSHR0cFByb3h5IHtcclxuICAgIHByaXZhdGUgc3RhdGljIGxvZzogSUxvZyA9IExvZ0ZhY3RvcnkuZ2V0KEh0dHBQcm94eSkgXHJcblxyXG4gICAgcHVibGljIHN0YXRpYyBkb1JlcXVlc3QoYXBpOiBzdHJpbmcsIHRva2VuQ2hlY2s6IGJvb2xlYW4sIHBhcmFtczogUGFyYW1zKSB7XHJcbiAgICAgICAgbGV0IHJlc3VsdDogUHJvbWlzZTxJQ29tbW9uUmVzcG9uc2U+XHJcbiAgICAgICAgaWYodG9rZW5DaGVjaykge1xyXG4gICAgICAgICAgICBjb25zdCB0b2tlbjogSVRva2VuID0gd3guZ2V0U3RvcmFnZVN5bmMoJ3Rva2VuJylcclxuICAgICAgICAgICAgaWYoISF0b2tlbikge1xyXG4gICAgICAgICAgICAgICAgcGFyYW1zID0gcGFyYW1zIHx8IHt9O1xyXG4gICAgICAgICAgICAgICAgcGFyYW1zLmRhdGEgPSBwYXJhbXMuZGF0YSB8fCB7fTtcclxuICAgICAgICAgICAgICAgIE9iamVjdC5hc3NpZ24ocGFyYW1zLmRhdGEsIHsgYWNjZXNzX3Rva2VuOiB0b2tlbi5hY2Nlc3NfdG9rZW59KVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgXHJcbiAgICAgICAgaWYoY2ZnTW9jay5lbmFibGUpIHtcclxuICAgICAgICAgICAgdGhpcy5sb2cubG9nKCdtb2NrIHJlcXVlc3Q6ICcgKyBhcGksIHBhcmFtcylcclxuICAgICAgICAgICAgcmVzdWx0ID0gbmV3IFByb21pc2U8SUNvbW1vblJlc3BvbnNlPigocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XHJcbiAgICAgICAgICAgICAgICBnZXRNb2NrKHt1cmw6IGFwaSwgYm9keTogcGFyYW1zfSkudGhlbihyZXMgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMubG9nLmxvZygnbW9jayByZXNwb25zZTogJyArIGFwaSwgcmVzKVxyXG4gICAgICAgICAgICAgICAgICAgIHJlc29sdmUocmVzKVxyXG4gICAgICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgfSkgXHJcbiAgICAgICAgfSBlbHNlIHsgICAgIFxyXG4gICAgICAgICAgICBhcGkgPSB0aGlzLnVybFByZWZpeChhcGksIGFwaVByZWZpeCk7ICAgICAgXHJcbiAgICAgICAgICAgIGNvbnN0IGh0dHBBcGkgPSB0aGlzLmFuYWx5emVBcGkoYXBpKVxyXG4gICAgICAgICAgICBpZighIXBhcmFtcyAmJiAhIXBhcmFtcy5wYXRoKSB7XHJcbiAgICAgICAgICAgICAgICBodHRwQXBpLnVybCA9IHRoaXMudXJsRm9ybWF0KGh0dHBBcGkudXJsLCBwYXJhbXMucGF0aClcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB0aGlzLmxvZy5sb2coJ3JlcXVzZXQ6ICcgKyBIdHRwTWV0aG9kW2h0dHBBcGkubWV0aG9kXSArJyAnICsgaHR0cEFwaS51cmwsIHBhcmFtcy5kYXRhKVxyXG4gICAgICAgICAgICBjb25zdCBtZXRob2Q6IGFueSA9IEh0dHBNZXRob2RbaHR0cEFwaS5tZXRob2RdXHJcbiAgICAgICAgICAgIHJlc3VsdCA9IG5ldyBQcm9taXNlPElDb21tb25SZXNwb25zZT4oKHJlc29sdmUsIHJlamVjdCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgd3gucmVxdWVzdCh7XHJcbiAgICAgICAgICAgICAgICAgICAgdXJsOiBodHRwQXBpLnVybCxcclxuICAgICAgICAgICAgICAgICAgICBkYXRhOiBwYXJhbXMuZGF0YSxcclxuICAgICAgICAgICAgICAgICAgICBtZXRob2Q6IG1ldGhvZCxcclxuICAgICAgICAgICAgICAgICAgICBoZWFkZXI6IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgJ0NvbnRlbnQtVHlwZSc6ICdhcHBsaWNhdGlvbi9qc29uJ1xyXG4gICAgICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICAgICAgc3VjY2VzczogKHJlczogYW55KSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubG9nLmxvZygncmVzcG9uc2U6ICcgKyBIdHRwTWV0aG9kW2h0dHBBcGkubWV0aG9kXSArJyAnICsgaHR0cEFwaS51cmwsIHJlcy5kYXRhKVxyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmRlYWxXaXRoQ29kZSh7cmVzcG9uc2U6IHJlcywgcmVzb2x2ZSwgcmVqZWN0fSlcclxuICAgICAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgICAgIGZhaWw6IChyZXM6IGFueSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZWplY3QocmVzKVxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgIH0pXHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiByZXN1bHRcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIHN0YXRpYyBkZWFsV2l0aENvZGUoe3Jlc3BvbnNlLCByZXNvbHZlLCByZWplY3R9OiBJRGVhbFdpdGhDb2RlT3B0aW9uKSB7XHJcbiAgICAgICAgY29uc3QgZGF0YVJlc3BvbnNlOiBJQ29tbW9uUmVzcG9uc2UgPSByZXNwb25zZS5kYXRhXHJcbiAgICAgICAgaWYoISFkYXRhUmVzcG9uc2UgJiYgZGF0YVJlc3BvbnNlLmNvZGUgPT09IDEwMCl7XHJcbiAgICAgICAgICAgIHJlc29sdmUoZGF0YVJlc3BvbnNlKVxyXG4gICAgICAgIH1lbHNlIGlmKGRhdGFSZXNwb25zZS5jb2RlID09PSAyMTAgfHwgZGF0YVJlc3BvbnNlLmNvZGUgPT09IDIyMCl7XHJcbiAgICAgICAgICAgIHJlamVjdChkYXRhUmVzcG9uc2UpXHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgd3guc2hvd01vZGFsKHtcclxuICAgICAgICAgICAgICAgIHRpdGxlOiBcIuaOpeWPo+ivt+axguWHuumUmVwiLFxyXG4gICAgICAgICAgICAgICAgc2hvd0NhbmNlbDogZmFsc2UsXHJcbiAgICAgICAgICAgICAgICBjb250ZW50OiBkYXRhUmVzcG9uc2UucmVzdWx0ICsgYCgke2RhdGFSZXNwb25zZS5jb2RlfSlgXHJcbiAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgcmVqZWN0KGRhdGFSZXNwb25zZSk7XHJcbiAgICAgICAgfVxyXG4gICAgfSAgIFxyXG5cclxuICAgIHByaXZhdGUgc3RhdGljIHVybEZvcm1hdCAodXJsOiBzdHJpbmcsIHBhdGhQYXJhbT86IGFueSk6IHN0cmluZyB7XHJcbiAgICAgICAgbGV0IHJlc3VsdCA9IHVybDtcclxuICAgICAgICBpZighIXBhdGhQYXJhbSkge1xyXG4gICAgICAgICAgICBmb3IoY29uc3Qga2V5IGluIHBhdGhQYXJhbSkge1xyXG4gICAgICAgICAgICAgICAgaWYocGF0aFBhcmFtLmhhc093blByb3BlcnR5KGtleSkpIHtcclxuICAgICAgICAgICAgICAgICAgICByZXN1bHQgPSByZXN1bHQucmVwbGFjZSgneycgKyBrZXkgKyAnfScsIHBhdGhQYXJhbVtrZXldKVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiByZXN1bHQ7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBzdGF0aWMgYW5hbHl6ZUFwaSAoYXBpOiBzdHJpbmcgfCBBcGkpOiBBcGkge1xyXG4gICAgICAgIGxldCByZXN1bHQ6IEFwaTtcclxuICAgICAgICBpZih0eXBlb2YgYXBpID09PSAnc3RyaW5nJykge1xyXG4gICAgICAgICAgICBjb25zdCBzcGxpdHMgPSBhcGkuc3BsaXQoJyAnKTtcclxuICAgICAgICAgICAgbGV0IG1ldGhvZDogSHR0cE1ldGhvZCA9IEh0dHBNZXRob2QuR0VUO1xyXG4gICAgICAgICAgICBsZXQgdXJsOiBzdHJpbmc7XHJcbiAgICAgICAgICAgIGlmKHNwbGl0cy5sZW5ndGggPT09IDEpIHtcclxuICAgICAgICAgICAgICAgIHVybCA9IHNwbGl0c1swXTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHVybCA9IHNwbGl0c1sxXTtcclxuICAgICAgICAgICAgICAgIHN3aXRjaChzcGxpdHNbMF0udG9Mb3dlckNhc2UoKSkge1xyXG4gICAgICAgICAgICAgICAgICAgIGNhc2UgJ3Bvc3QnOlxyXG4gICAgICAgICAgICAgICAgICAgICAgICBtZXRob2QgPSBIdHRwTWV0aG9kLlBPU1Q7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgICAgIGNhc2UgJ3B1dCc6XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIG1ldGhvZCA9IEh0dHBNZXRob2QuUFVUO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgICAgICBjYXNlICdkZWxldGUnOlxyXG4gICAgICAgICAgICAgICAgICAgICAgICBtZXRob2QgPSBIdHRwTWV0aG9kLkRFTEVURTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgICAgICAgICAgZGVmYXVsdDpcclxuICAgICAgICAgICAgICAgICAgICAgICAgbWV0aG9kID0gSHR0cE1ldGhvZC5HRVRcclxuICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgcmVzdWx0ID0ge1xyXG4gICAgICAgICAgICAgICAgbWV0aG9kOiBtZXRob2QsXHJcbiAgICAgICAgICAgICAgICB1cmw6IHVybFxyXG4gICAgICAgICAgICB9XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICAgIHJlc3VsdCA9IGFwaTtcclxuICAgIH1cclxuICAgIHJldHVybiByZXN1bHQ7XHJcbiAgICAgICAgXHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBzdGF0aWMgdXJsUHJlZml4KHVybDogc3RyaW5nLCBwcmVmaXg6IHN0cmluZykgOiBzdHJpbmd7XHJcbiAgICAgICAgbGV0IHJlc3VsdDogc3RyaW5nID0gdXJsO1xyXG4gICAgICAgIGlmKCEhcHJlZml4KSB7XHJcbiAgICAgICAgICAgIGlmKHVybC5pbmRleE9mKCcgJykgPiAwKSB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBzcGxpdHMgPSB1cmwuc3BsaXQoJyAnKVxyXG4gICAgICAgICAgICAgICAgcmVzdWx0ID0gc3BsaXRzWzBdICsgJyAnICsgcHJlZml4ICsgJy8nICsgc3BsaXRzWzFdO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgcmVzdWx0ID0gcHJlZml4ICsgJy8nICsgcmVzdWx0XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIHJlc3VsdDtcclxuICAgIH0gICBcclxufSJdfQ==
