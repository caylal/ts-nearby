"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var http_proxy_1 = require("./http.proxy");
var cfg_config_1 = require("../config/cfg.config");
var util_1 = require("../utils/util");
var HttpBase = (function () {
    function HttpBase() {
        this.freshStatus = false;
    }
    HttpBase.prototype.get = function (url, params) {
        return this.request(url, params);
    };
    HttpBase.prototype.post = function (url, params) {
        return this.request(url, params);
    };
    HttpBase.prototype.put = function (url, params) {
        return this.request(url, params);
    };
    HttpBase.prototype.delete = function (url, params) {
        return this.request(url, params);
    };
    HttpBase.prototype.request = function (api, params) {
        var _this = this;
        return new Promise(function (resolve, reject) {
            if (_this.guard(api)) {
                var token = wx.getStorageSync('token');
                var dtNow = new Date().valueOf();
                if (!!token && token.expired < dtNow) {
                    if (!_this.freshStatus) {
                        _this.freshStatus = true;
                        http_proxy_1.HttpProxy.doRequest(cfg_config_1.Auth.refreshTokenUrl, false, { data: { refreshToken: token.refresh_token } }).then(function (res) {
                            var response_res = res.result;
                            if (response_res.token) {
                                response_res.token.expired = util_1.transExpiresDt(response_res.token.expires_in);
                                wx.setStorageSync('token', response_res.token);
                                _this.freshStatus = false;
                                http_proxy_1.HttpProxy.doRequest(api, true, params).then(function (res) {
                                    resolve(res);
                                }).catch(function (err) {
                                    reject(err);
                                });
                            }
                        }).catch(function (err) {
                            if (err.code === 210 || err.code === 220) {
                            }
                        });
                    }
                    else {
                        var result = _this.recurRequest(api, params);
                        resolve(result);
                    }
                }
                else {
                    http_proxy_1.HttpProxy.doRequest(api, true, params).then(function (res) { return resolve(res); }).catch(function (err) { return reject(err); });
                }
            }
            else {
                http_proxy_1.HttpProxy.doRequest(api, false, params).then(function (res) { return resolve(res); }).catch(function (err) { return reject(err); });
            }
        });
    };
    HttpBase.prototype.guard = function (api) {
        var result = false;
        if (cfg_config_1.Auth.enable) {
            result = true;
            if (api.indexOf(cfg_config_1.Auth.refreshTokenUrl) > 0) {
                result = false;
            }
            else if (api.indexOf(cfg_config_1.Auth.login) > 0) {
                result = false;
            }
        }
        return result;
    };
    HttpBase.prototype.recurRequest = function (api, params) {
        var _this = this;
        var result;
        if (this.freshStatus) {
            setTimeout(function () {
                _this.recurRequest(api, params);
            }, 1000);
        }
        else {
            result = http_proxy_1.HttpProxy.doRequest(api, true, params);
        }
        return result;
    };
    return HttpBase;
}());
exports.HttpBase = HttpBase;

//# sourceMappingURL=data:application/json;charset=utf8;base64,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LGlCQVVDO1FBVEcsSUFBSSxNQUFnQyxDQUFDO1FBQ3JDLElBQUcsSUFBSSxDQUFDLFdBQVcsRUFBRTtZQUNqQixVQUFVLENBQUM7Z0JBQ1AsS0FBSSxDQUFDLFlBQVksQ0FBQyxHQUFHLEVBQUUsTUFBTSxDQUFDLENBQUE7WUFDbEMsQ0FBQyxFQUFFLElBQUksQ0FBQyxDQUFBO1NBQ1g7YUFBSztZQUNGLE1BQU0sR0FBRyxzQkFBUyxDQUFDLFNBQVMsQ0FBQyxHQUFHLEVBQUUsSUFBSSxFQUFFLE1BQU0sQ0FBQyxDQUFBO1NBQ2xEO1FBQ0QsT0FBTyxNQUFNLENBQUE7SUFDakIsQ0FBQztJQUNMLGVBQUM7QUFBRCxDQXBGQSxBQW9GQyxJQUFBO0FBcEZZLDRCQUFRIiwiZmlsZSI6Imh0dHBzL2h0dHAuYmFzZS5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7SUh0dHAsIElUb2tlbiwgUGFyYW1zLCBJUmVzcG9uc2VSZXN1bHQsIElDb21tb25SZXNwb25zZX0gZnJvbSAnLi9odHRwLmludGVyZmFjZSdcclxuaW1wb3J0IHtIdHRwUHJveHl9IGZyb20gJy4vaHR0cC5wcm94eSdcclxuaW1wb3J0IHtBdXRofSBmcm9tICcuLi9jb25maWcvY2ZnLmNvbmZpZydcclxuaW1wb3J0IHt0cmFuc0V4cGlyZXNEdH0gZnJvbSAnLi4vdXRpbHMvdXRpbCdcclxuZXhwb3J0IGNsYXNzIEh0dHBCYXNlIGltcGxlbWVudHMgSUh0dHAge1xyXG4gICAgcHJpdmF0ZSBmcmVzaFN0YXR1czogYm9vbGVhbiA9IGZhbHNlXHJcbiAgICBnZXQodXJsOiBzdHJpbmcsIHBhcmFtczogUGFyYW1zKTogUHJvbWlzZTxJQ29tbW9uUmVzcG9uc2U+e1xyXG4gICAgICAgIHJldHVybiB0aGlzLnJlcXVlc3QodXJsLCBwYXJhbXMpXHJcbiAgICB9XHJcbiAgICBwb3N0KHVybDogc3RyaW5nLCBwYXJhbXM6IFBhcmFtcyk6IFByb21pc2U8SUNvbW1vblJlc3BvbnNlPntcclxuICAgICAgICByZXR1cm4gdGhpcy5yZXF1ZXN0KHVybCwgcGFyYW1zKVxyXG4gICAgfVxyXG4gICAgcHV0KHVybDogc3RyaW5nLCBwYXJhbXM6IFBhcmFtcyk6IFByb21pc2U8SUNvbW1vblJlc3BvbnNlPntcclxuICAgICAgICByZXR1cm4gdGhpcy5yZXF1ZXN0KHVybCwgcGFyYW1zKVxyXG4gICAgfVxyXG4gICAgZGVsZXRlKHVybDogc3RyaW5nLCBwYXJhbXM6IFBhcmFtcyk6IFByb21pc2U8SUNvbW1vblJlc3BvbnNlPntcclxuICAgICAgICByZXR1cm4gdGhpcy5yZXF1ZXN0KHVybCwgcGFyYW1zKVxyXG4gICAgfVxyXG5cclxuICAgIHByb3RlY3RlZCByZXF1ZXN0KGFwaTogc3RyaW5nLCBwYXJhbXM6IFBhcmFtcyk6IFByb21pc2U8SUNvbW1vblJlc3BvbnNlPiB7XHJcbiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlPElDb21tb25SZXNwb25zZT4oKHJlc29sdmUsIHJlamVjdCkgPT4ge1xyXG4gICAgICAgICAgICBpZih0aGlzLmd1YXJkKGFwaSkpIHtcclxuICAgICAgICAgICAgICAgY29uc3QgdG9rZW46IElUb2tlbiA9IHd4LmdldFN0b3JhZ2VTeW5jKCd0b2tlbicpXHJcbiAgICAgICAgICAgICAgIGNvbnN0IGR0Tm93OiBudW1iZXIgPSBuZXcgRGF0ZSgpLnZhbHVlT2YoKVxyXG4gICAgICAgICAgICAgICBpZighIXRva2VuICYmIHRva2VuLmV4cGlyZWQgPCBkdE5vdykge1xyXG4gICAgICAgICAgICAgICAgICAgaWYoIXRoaXMuZnJlc2hTdGF0dXMpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmZyZXNoU3RhdHVzID0gdHJ1ZVxyXG4gICAgICAgICAgICAgICAgICAgICAgIEh0dHBQcm94eS5kb1JlcXVlc3QoQXV0aC5yZWZyZXNoVG9rZW5VcmwsIGZhbHNlLCB7ZGF0YToge3JlZnJlc2hUb2tlbjogdG9rZW4ucmVmcmVzaF90b2tlbn19KS50aGVuKHJlcyA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCByZXNwb25zZV9yZXM6IElSZXNwb25zZVJlc3VsdCA9IHJlcy5yZXN1bHQgXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZihyZXNwb25zZV9yZXMudG9rZW4pe1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3BvbnNlX3Jlcy50b2tlbi5leHBpcmVkID0gdHJhbnNFeHBpcmVzRHQocmVzcG9uc2VfcmVzLnRva2VuLmV4cGlyZXNfaW4pXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgd3guc2V0U3RvcmFnZVN5bmMoJ3Rva2VuJywgcmVzcG9uc2VfcmVzLnRva2VuKVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZnJlc2hTdGF0dXMgPSBmYWxzZVxyXG5cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBIdHRwUHJveHkuZG9SZXF1ZXN0KGFwaSwgdHJ1ZSwgcGFyYW1zKS50aGVuKHJlcyA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc29sdmUocmVzKVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pLmNhdGNoKGVyciA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlamVjdChlcnIpXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gXHJcbiAgICAgICAgICAgICAgICAgICAgICAgfSkuY2F0Y2goZXJyID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoZXJyLmNvZGUgPT09IDIxMCB8fCBlcnIuY29kZSA9PT0gMjIwKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gd3gucmVtb3ZlU3RvcmFnZVN5bmMoJ3VzZXJJbmZvJylcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyB3eC5yZW1vdmVTdG9yYWdlU3luYygndG9rZW4nKVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHd4LnJlbW92ZVN0b3JhZ2VTeW5jKCd3eCcpXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gY29uc3QgdXJsID0gZ2V0UGFnZVVybCgpXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gd3gucmVkaXJlY3RUbyh7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gICAgIHVybDogJy9wYWdlcy9hdXRob3JpemUvaW5kZXg/dXJsPS8nICsgdXJsLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIH0pXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gY29uc29sZS5sb2codXJsKVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgLy90b2tlbuWIt+aWsOS4rVxyXG4gICAgICAgICAgICAgICAgICAgICAgIGxldCByZXN1bHQgPSB0aGlzLnJlY3VyUmVxdWVzdChhcGksIHBhcmFtcylcclxuICAgICAgICAgICAgICAgICAgICAgICByZXNvbHZlKHJlc3VsdClcclxuICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIEh0dHBQcm94eS5kb1JlcXVlc3QoYXBpLCB0cnVlLCBwYXJhbXMpLnRoZW4ocmVzID0+IHJlc29sdmUocmVzKSkuY2F0Y2goZXJyID0+IHJlamVjdChlcnIpKVxyXG4gICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICBIdHRwUHJveHkuZG9SZXF1ZXN0KGFwaSwgZmFsc2UsIHBhcmFtcykudGhlbihyZXMgPT4gcmVzb2x2ZShyZXMpKS5jYXRjaChlcnIgPT4gcmVqZWN0KGVycikpXHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KVxyXG4gICAgfVxyXG4gICAgcHJpdmF0ZSBndWFyZChhcGk6IHN0cmluZyk6Ym9vbGVhbiB7XHJcbiAgICAgICAgbGV0IHJlc3VsdDogYm9vbGVhbiA9IGZhbHNlO1xyXG4gICAgICAgIGlmKEF1dGguZW5hYmxlKSB7XHJcbiAgICAgICAgICAgIHJlc3VsdCA9IHRydWVcclxuICAgICAgICAgICAgaWYoYXBpLmluZGV4T2YoQXV0aC5yZWZyZXNoVG9rZW5VcmwpID4gMCkge1xyXG4gICAgICAgICAgICAgICAgcmVzdWx0ID0gZmFsc2VcclxuICAgICAgICAgICAgfSBlbHNlIGlmKGFwaS5pbmRleE9mKEF1dGgubG9naW4pID4gMCl7XHJcbiAgICAgICAgICAgICAgICByZXN1bHQgPSBmYWxzZVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiByZXN1bHRcclxuICAgIH1cclxuICAgIHByaXZhdGUgIHJlY3VyUmVxdWVzdChhcGk6IHN0cmluZywgcGFyYW1zOiBQYXJhbXMpIHtcclxuICAgICAgICBsZXQgcmVzdWx0OiBQcm9taXNlPElDb21tb25SZXNwb25zZT47XHJcbiAgICAgICAgaWYodGhpcy5mcmVzaFN0YXR1cykge1xyXG4gICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHtcclxuICAgICAgICAgICAgICAgIHRoaXMucmVjdXJSZXF1ZXN0KGFwaSwgcGFyYW1zKVxyXG4gICAgICAgICAgICB9LCAxMDAwKVxyXG4gICAgICAgIH1lbHNlIHtcclxuICAgICAgICAgICAgcmVzdWx0ID0gSHR0cFByb3h5LmRvUmVxdWVzdChhcGksIHRydWUsIHBhcmFtcylcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIHJlc3VsdFxyXG4gICAgfVxyXG59Il19
